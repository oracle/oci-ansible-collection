---
- block:
  - name: Create dependency vcn with required parameters
    oci_network_vcn:
      cidr_block: "10.0.0.0/16"
      compartment_id: "{{ test_compartment_ocid }}"
      display_name: "{{ 'MyVcn' + random_suffix_1024 }}"
    register: result

  - name: Assert resource was created
    assert:
      that:
        - result.changed == True
  - set_fact:
      dependency_vcn_id: "{{ result.vcn.id }}"

# ==================================================================================================== #

  - name: Create dependency service_gateway with required parameters
    oci_network_service_gateway:
      compartment_id: "{{ test_compartment_ocid }}"
      display_name: "{{ 'display_name_example' + random_suffix_1024 }}"
      vcn_id: "{{ dependency_vcn_id }}"
      services: []
    register: result

  - name: Assert resource was created
    assert:
      that:
        - result.changed == True

  - set_fact:
      service_gateway_resource_id: "{{ result.service_gateway.id }}"

  - name: Assert required properties are populated
    assert:
      that:
        - result.service_gateway.block_traffic is defined
        - result.service_gateway.compartment_id is defined
        - result.service_gateway.id is defined
        - result.service_gateway.lifecycle_state is defined
        - result.service_gateway.services is defined
        - result.service_gateway.vcn_id is defined

  # ==================================================================================================== #

  - name: Attach a service to the service gateway
    oci_network_service_gateway_actions:
      service_gateway_id: "{{ service_gateway_resource_id }}"
      service_id: "{{ service_resource_id }}"
      action: attach_service_id
    register: result

  - name: Assert changed is True and service gateway is updated
    assert:
      that:
        - result.changed == True
        - result.service_gateway.lifecycle_state == "AVAILABLE"
        - result.service_gateway.services[0].service_id == service_resource_id

  # ===========================================================================================

  - name: Attempt to attach service again
    oci_network_service_gateway_actions:
      service_gateway_id: "{{ service_gateway_resource_id }}"
      service_id: "{{ service_resource_id }}"
      action: attach_service_id
    register: result

  - name: Assert changed is false and service gateway is retrieved
    assert:
      that:
        - result.changed == False
        - result.service_gateway.lifecycle_state == "AVAILABLE"
        - result.service_gateway.id == service_gateway_resource_id

  # ===========================================================================================

  - name: Detach a service
    oci_network_service_gateway_actions:
      service_gateway_id: "{{ service_gateway_resource_id }}"
      service_id: "{{ service_resource_id }}"
      action: detach_service_id
    register: result

  - name: Assert changed is True and service is detached
    assert:
      that:
        - result.changed == True
        - result.service_gateway.services | length == 0

  # ===========================================================================================

  - name: Attempt again to detach a service
    oci_network_service_gateway_actions:
      service_gateway_id: "{{ service_gateway_resource_id }}"
      service_id: "{{ service_resource_id }}"
      action: detach_service_id
    register: result

  - name: Assert changed is False
    assert:
      that:
        - result.changed == False
        - result.service_gateway.services | length == 0

  # ==================================================================================================== #


  always:

    - name: Delete service_gateway
      oci_network_service_gateway:
        service_gateway_id: "{{ service_gateway_resource_id }}"
        state: absent
      register: result
      ignore_errors: yes

    - name: Delete dependency vcn
      oci_network_vcn:
        vcn_id: "{{ dependency_vcn_id }}"
        state: absent
      ignore_errors: yes
