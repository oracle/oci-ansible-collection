# tests for `oci_identity_tag_default` and `oci_identity_tag_default_facts`

- block:

    # oci_identity_tag_facts is not yet released
    # - name: Get tag definition
    #   oci_identity_tag_facts:
    #     tag_namespace_id: "{{ test_tag_default_namespace_ocid }}"
    #     name: "{{ test_tag_default_tag_name }}"
    #   register: tag_definitions_result

    - set_fact:
        test_tag_definition_id: "{{ test_tag_default_tag_ocid }}"

    - name: add tag default - check mode
      oci_identity_tag_default:
        compartment_id: "{{ test_tag_default_tests_compartment_ocid }}"
        tag_definition_id: "{{ test_tag_definition_id }}"
        value: "test_tag_default_value_{{ random_suffix_1024 }}"
      register: create_tag_default_check_mode_result
      check_mode: yes

    - name: Assert that changed is True but tag default is not created
      assert:
        that:
          - create_tag_default_check_mode_result.changed == True
          - create_tag_default_check_mode_result.tag_default.id is not defined

    - name: add tag default
      oci_identity_tag_default:
        compartment_id: "{{ test_tag_default_tests_compartment_ocid }}"
        tag_definition_id: "{{ test_tag_definition_id }}"
        value: "test_tag_default_value_{{ random_suffix_1024 }}"
      register: create_tag_default_result

    - name: Assert that tag default is created
      assert:
        that:
        - create_tag_default_result.changed == True
        - create_tag_default_result.tag_default.id is defined

    - set_fact:
        test_tag_default_id: "{{ create_tag_default_result.tag_default.id }}"

    - name: add tag default - idempotence test
      oci_identity_tag_default:
        compartment_id: "{{ test_tag_default_tests_compartment_ocid }}"
        tag_definition_id: "{{ test_tag_definition_id }}"
        value: "{{ test_tag_default_value }}"
      register: create_tag_default_idempotence_result

    - name: Assert that tag default is not created
      assert:
        that:
        - create_tag_default_idempotence_result.changed == False

    - name: update tag default - check mode
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        value: "{{ updated_test_tag_default_value }}"
      register: update_tag_default_check_mode_result
      check_mode: yes

    - name: Assert that changed is True but tag default not updated in check mode
      assert:
        that:
          - update_tag_default_check_mode_result.changed == True

    - name: get the tag default
      oci_identity_tag_default_facts:
        tag_default_id: "{{ test_tag_default_id }}"
      register: tag_default_result

    - name: Assert that the check mode update did not actually update the tag default value
      assert:
        that:
          - tag_default_result.tag_defaults[0].value == test_tag_default_value

    - name: list the tag default
      oci_identity_tag_default_facts:
        compartment_id: "{{ test_tag_default_tests_compartment_ocid }}"
      register: list_tag_default_result

    - name: Assert that the tag defaults are listed
      assert:
        that:
        - list_tag_default_result.tag_defaults | length >= 1

    - name: update tag default
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        value: "updated_test_tag_default_value_{{ random_suffix_1024 }}"
      register: update_tag_default_result

    - name: Assert that changed is True and value is updated
      assert:
        that:
          - update_tag_default_result.changed == True
          - update_tag_default_result.tag_default.value == updated_test_tag_default_value

    - name: update tag default - idempotence
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        value: "updated_test_tag_default_value_{{ random_suffix_1024 }}"
      register: update_tag_default_idempotence_result

    - name: Assert that tag default is not updated
      assert:
        that:
        - update_tag_default_idempotence_result.changed == False

    - name: Delete tag default - check mode
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        state: absent
      register: delete_tag_default_check_mode_result
      check_mode: yes

    - name: Assert that changed is True
      assert:
        that:
          - delete_tag_default_check_mode_result.changed == True

    - name: Delete tag default
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        state: absent
      register: delete_tag_default_result

    - name: Assert that changed is True
      assert:
        that:
        - delete_tag_default_result.changed == True

    - name: Delete tag default - idempotence
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        state: absent
      register: delete_tag_default_idempotence_result

    - name: Assert that changed is False
      assert:
        that:
        - delete_tag_default_idempotence_result.changed == False

  rescue:

    - name: Delete tag default
      oci_identity_tag_default:
        tag_default_id: "{{ test_tag_default_id }}"
        state: absent
      ignore_errors: yes

    - fail:
        msg: "{{ ansible_failed_result }}"