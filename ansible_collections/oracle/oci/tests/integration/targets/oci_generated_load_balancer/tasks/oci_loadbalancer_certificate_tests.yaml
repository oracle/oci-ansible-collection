---
- block:
  - name: Create dependency load_balancer with required parameters
    oci_loadbalancer_load_balancer:
      compartment_id: "{{ test_compartment_ocid | oracle.oci.override(test_certificate_create_dependency_load_balancer_compartment_id, omit) }}"
      display_name: "{{ ('example_load_balancer' + random_suffix_1024) | oracle.oci.override(test_certificate_create_dependency_load_balancer_display_name, omit) }}"
      shape_name: "{{ '100Mbps' | oracle.oci.override(test_certificate_create_dependency_load_balancer_shape_name, omit) }}"
      subnet_ids: "{{ [ 'ocid1.subnet.oc1.phx.xxxxxxEXAMPLExxxxxx' ] | oracle.oci.override(test_certificate_create_dependency_load_balancer_subnet_ids, omit) }}"
    register: result
    when: skip_certificate_create_dependency_load_balancer_test is not defined and skip_certificate_dependencies is not defined
  - name: Assert resource was created
    assert:
      that:
        - result.changed == True
    when: skip_certificate_create_dependency_load_balancer_test is not defined and skip_certificate_dependencies is not defined
  - set_fact:
      dependency_load_balancer: "{{ result.load_balancer }}"
      dependency_load_balancer_id: "{{ result.load_balancer.id }}"
    when: skip_certificate_create_dependency_load_balancer_test is not defined and skip_certificate_dependencies is not defined
  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_dependency_load_balancer_custom_assertions }}"
    when: certificate_create_dependency_load_balancer_custom_assertions is defined

# ==================================================================================================== #

  - name: Create certificate (check mode)
    oci_loadbalancer_certificate:
      certificate_name: "{{ 'example_certificate_bundle' | oracle.oci.override(test_certificate_create_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_create_required_load_balancer_id, omit) }}"
    register: result
    check_mode: yes
    when: skip_certificate_create_check_mode_test is not defined

  - name: Assert resource would have been created
    assert:
      that:
        - result.changed == True
    when: skip_certificate_create_check_mode_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_check_mode_custom_assertions }}"
    when: certificate_create_check_mode_custom_assertions is defined

# ==================================================================================================== #

  - name: Create certificate with required parameters
    oci_loadbalancer_certificate:
      certificate_name: "{{ 'example_certificate_bundle' | oracle.oci.override(test_certificate_create_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_create_required_load_balancer_id, omit) }}"
    register: result
    when: skip_certificate_create_required_original_test is not defined

  - name: Assert resource was created
    assert:
      that:
        - result.changed == True
    when: skip_certificate_create_required_original_test is not defined

  - set_fact:
      certificate_resource_name: "{{ result.certificate.certificate_name }}"
    when: skip_certificate_create_required_original_test is not defined

  - set_fact:
      certificate: "{{ result.certificate }}"
    when: skip_certificate_create_required_original_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.certificate.certificate_name is defined
        - result.certificate.public_certificate is defined
        - result.certificate.ca_certificate is defined
    when: skip_certificate_create_required_original_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_required_original_custom_assertions }}"
    when: certificate_create_required_original_custom_assertions is defined

# ==================================================================================================== #

  - name: Re-create certificate with required parameters(idempotency)
    oci_loadbalancer_certificate:
      certificate_name: "{{ 'example_certificate_bundle' | oracle.oci.override(test_certificate_create_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_create_required_load_balancer_id, omit) }}"
    register: result
    when: skip_certificate_create_required_idempotency_test is not defined

  - name: Assert changed is False
    assert:
      that:
        - result.changed == False
    when: skip_certificate_create_required_idempotency_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.certificate.certificate_name is defined
        - result.certificate.public_certificate is defined
        - result.certificate.ca_certificate is defined
    when: skip_certificate_create_required_idempotency_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_required_idempotency_custom_assertions }}"
    when: certificate_create_required_idempotency_custom_assertions is defined

# ==================================================================================================== #

  - name: Delete certificate
    oci_loadbalancer_certificate:
      certificate_name: "{{ certificate_resource_name | oracle.oci.override(test_certificate_delete_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_delete_required_load_balancer_id, omit) }}"
      state: absent
    register: result
    when: skip_certificate_delete_required_test is not defined

  - name: Assert resource was deleted
    assert:
      that:
        - result.changed == True
    when: skip_certificate_delete_required_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.certificate.certificate_name is defined
        - result.certificate.public_certificate is defined
        - result.certificate.ca_certificate is defined
    when: skip_certificate_delete_required_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_delete_required_custom_assertions }}"
    when: certificate_delete_required_custom_assertions is defined

# ==================================================================================================== #

  - name: Delete certificate (idempotency)
    oci_loadbalancer_certificate:
      certificate_name: "{{ certificate_resource_name | oracle.oci.override(test_certificate_delete_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_delete_required_load_balancer_id, omit) }}"
      state: absent
    register: result
    when: skip_certificate_delete_required_idempotency_test is not defined

  - name: Assert changed is False
    assert:
      that:
        - result.changed == False
    when: skip_certificate_delete_required_idempotency_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_delete_required_idempotency_custom_assertions }}"
    when: certificate_delete_required_idempotency_custom_assertions is defined

# ==================================================================================================== #

  - name: Create certificate with optional + required parameters
    oci_loadbalancer_certificate:
      passphrase: "{{ 'passphrase&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_passphrase, omit) }}"
      private_key: "{{ 'private_key&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_private_key, omit) }}"
      public_certificate: "{{ 'public_certificate&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_public_certificate, omit) }}"
      ca_certificate: "{{ 'ca_certificate&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_ca_certificate, omit) }}"
      certificate_name: "{{ 'example_certificate_bundle' | oracle.oci.override(test_certificate_create_optional_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_create_optional_required_load_balancer_id, omit) }}"
    register: result
    when: skip_certificate_create_optional_required_original_test is not defined

  - name: Assert changed is True
    assert:
      that:
        - result.changed == True
    when: skip_certificate_create_optional_required_original_test is not defined

  - set_fact:
      certificate_resource_name: "{{ result.certificate.certificate_name }}"
    when: skip_certificate_create_optional_required_original_test is not defined

  - set_fact:
      certificate: "{{ result.certificate }}"
    when: skip_certificate_create_optional_required_original_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.certificate.certificate_name is defined
        - result.certificate.public_certificate is defined
        - result.certificate.ca_certificate is defined
    when: skip_certificate_create_optional_required_original_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_optional_required_original_custom_assertions }}"
    when: certificate_create_optional_required_original_custom_assertions is defined

# ==================================================================================================== #

  - name: Re-create certificate with optional + required parameters (idempotence)
    oci_loadbalancer_certificate:
      passphrase: "{{ 'passphrase&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_passphrase, omit) }}"
      private_key: "{{ 'private_key&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_private_key, omit) }}"
      public_certificate: "{{ 'public_certificate&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_public_certificate, omit) }}"
      ca_certificate: "{{ 'ca_certificate&gt</var>' | oracle.oci.override(test_certificate_create_optional_required_ca_certificate, omit) }}"
      certificate_name: "{{ 'example_certificate_bundle' | oracle.oci.override(test_certificate_create_optional_required_certificate_name, omit) }}"
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_create_optional_required_load_balancer_id, omit) }}"
    register: result
    when: skip_certificate_create_optional_required_idempotence_test is not defined

  - name: Assert changed is False
    assert:
      that:
        - result.changed == False
    when: skip_certificate_create_optional_required_idempotence_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.certificate.certificate_name is defined
        - result.certificate.public_certificate is defined
        - result.certificate.ca_certificate is defined
    when: skip_certificate_create_optional_required_idempotence_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_create_optional_required_idempotence_custom_assertions }}"
    when: certificate_create_optional_required_idempotence_custom_assertions is defined

# ==================================================================================================== #

  - name: List certificates
    oci_loadbalancer_certificate_facts:
      load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_list_load_balancer_id, omit) }}"
    register: result
    when: skip_certificate_list_test is not defined

  - name: Assert resource was listed
    assert:
      that:
        - result['certificates'] | length > 0
    when: skip_certificate_list_test is not defined


  - name: Assert response properties are populated
    assert:
      that:
        - item.certificate_name is defined
        - item.public_certificate is defined
        - item.ca_certificate is defined
    with_items: "{{ result['certificates'] }}"
    when: skip_certificate_list_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ certificate_list_custom_assertions }}"
    when: certificate_list_custom_assertions is defined

  always:

    - name: Delete certificate
      oci_loadbalancer_certificate:
        certificate_name: "{{ certificate_resource_name | oracle.oci.override(test_certificate_delete_rescue_certificate_name, omit) }}"
        load_balancer_id: "{{ dependency_load_balancer_id | oracle.oci.override(test_certificate_delete_rescue_load_balancer_id, omit) }}"
        state: absent
      register: result
      ignore_errors: yes
      when: certificate_resource_name is defined

    - name: Delete dependency load_balancer
      oci_loadbalancer_load_balancer:
        load_balancer_id: "{{ dependency_load_balancer_id }}"
        state: absent
      ignore_errors: yes
      when: skip_certificate_delete_dependency_load_balancer_test is not defined and skip_certificate_dependencies is not defined and dependency_load_balancer_id is defined
