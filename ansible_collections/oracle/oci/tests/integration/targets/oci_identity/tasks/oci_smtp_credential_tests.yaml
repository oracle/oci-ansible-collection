# tests for `oci_smtp_credential` and `oci_smtp_credential_facts`

# XXX: Running as a temporary user is not working, and therefore
# hardcoding the user for now. This has problems while running this test
# in parallel in two CI runs. Find out why the temprorary user cas eis
# not working
#
# Set the test User as the same user running the integration tests
- set_fact:
    smtp_credential_test_user_ocid: "ocid1.user.oc1..aaaaaaaai2i2pnl4stjcwziua2rljsvku7xr7vyqtsiskqqnjzsjhfhvbj2a"
- name:
  debug:
    msg: "User for test {{ smtp_credential_test_user_ocid }}"
# ===========================================================================================
- name: Create an SMTP credential
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    description: "{{ smtp_credential_description }}"
  register: result
- set_fact:
     smtp_credential_ocid: "{{ result.smtp_credential.id }}"
- debug: msg="{{result}}"
- name: Assert that SMTP credential was created and is active
  assert:
    that:
        - result.changed == True
        - result.smtp_credential.lifecycle_state == "ACTIVE"
# ===========================================================================================
- name: Try to Create same SMTP credential, Idempotency Check
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    description: "{{ smtp_credential_description }}"
  register: result
- set_fact:
     idempotent_smtp_credential_ocid: "{{ result.smtp_credential.id }}"

- name: Assert that changed is False and the old SMTP credential is returned
  assert:
    that:
        - result.changed == False
        - result.smtp_credential.lifecycle_state == "ACTIVE"
        - idempotent_smtp_credential_ocid == smtp_credential_ocid
# ===========================================================================================
- name: Get SMTP credential facts about user
  oci_identity_smtp_credential_facts:
    user_id: "{{ smtp_credential_test_user_ocid }}"
  register: result
- name: Assert that SMTP credential facts were retrieved
  assert:
    that:
        - result.changed == False
        - result.smtp_credentials[0].lifecycle_state == "ACTIVE"
# ===========================================================================================
- name: Update description of SMTP credential
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    id: "{{ smtp_credential_ocid }}"
    description: "{{ smtp_credential_updated_description }}"
  register: result
- name: Assert that SMTP credential was updated with new description and remains active
  assert:
    that:
        - result.changed == True
        - result.smtp_credential.lifecycle_state == "ACTIVE"
        - result.smtp_credential.description == smtp_credential_updated_description
# ===========================================================================================
- name: Update description of SMTP credential, idempotency test
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    id: "{{ smtp_credential_ocid }}"
    description: "{{ smtp_credential_updated_description }}"
  register: result
- name: Assert that SMTP credential was not changed
  assert:
    that:
        - result.changed == False
        - result.smtp_credential.lifecycle_state == "ACTIVE"
        - result.smtp_credential.description == smtp_credential_updated_description
# ===========================================================================================
- name: Delete the SMTP credential
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    id: "{{ smtp_credential_ocid }}"
    state: "absent"
  register: result
- name: Assert that SMTP credential was deleted
  assert:
    that:
        - result.changed == True
        - result.smtp_credential.lifecycle_state == "DELETED"
# ===========================================================================================
- name: Try to Delete the SMTP credential, Idempotent Test
  oci_identity_smtp_credential:
    user_id: "{{ smtp_credential_test_user_ocid }}"
    id: "{{ smtp_credential_ocid }}"
    state: "absent"
  register: result
- name: Assert that changed is False
  assert:
    that:
        - result.changed == False
