---
- block:
    - name: Perform action disable on key
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: disable
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is true
      assert:
        that:
        - result.changed == True
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "DISABLED"

    - name: Perform action disable on key - idempotency
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: disable
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is false
      assert:
        that:
        - result.changed == False
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "DISABLED"

    - name: Perform action enable on key
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: enable
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is true
      assert:
        that:
        - result.changed == True
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "ENABLED"

    - name: Perform action enable on key - idempotency
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: enable
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is false
      assert:
        that:
        - result.changed == False
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "ENABLED"
# ==================================================================================================== #
    - name: Perform action schedule_key_deletion on key
      oci_key_management_key_actions:
        time_of_deletion: "{{ current_date_time }}"
        key_id: "{{ dependency_key_id }}"
        action: schedule_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is true
      assert:
        that:
        - result.changed == True
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "PENDING_DELETION"

    # Idempotency works only when delete date is the same as original
    - name: Perform action schedule_key_deletion on key - idempotency
      oci_key_management_key_actions:
        time_of_deletion: "{{ current_date_time }}"
        key_id: "{{ dependency_key_id }}"
        action: schedule_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is false
      assert:
        that:
        - result.changed == False
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "PENDING_DELETION"

    - name: Perform action schedule_key_deletion on key - (confirm throws)
      oci_key_management_key_actions:
        time_of_deletion: "2020-10-20T18:22:58.500Z"
        key_id: "{{ dependency_key_id }}"
        action: schedule_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
      ignore_errors: yes
    - name: Assert that delete with worng date failed
      assert:
        that:
          - 'result.failed'

    - name: Perform action cancel_key_deletion on key
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: cancel_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is true
      assert:
        that:
        - result.changed == True
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "ENABLED"

    - name: Perform action cancel_key_deletion on key - idempotency
      oci_key_management_key_actions:
        key_id: "{{ dependency_key_id }}"
        action: cancel_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is false
      assert:
        that:
        - result.changed == False
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "ENABLED"

  always:
    - name: Perform final action schedule_key_deletion on key
      oci_key_management_key_actions:
        time_of_deletion: "{{ current_date_time }}"
        key_id: "{{ dependency_key_id }}"
        action: schedule_key_deletion
        service_endpoint: "{{ test_kmsmanagement_service_endpoint }}"
      register: result
    - name: Assert that changed is true
      assert:
        that:
        - result.changed == True
        - result.key.id == dependency_key_id
        - result.key.lifecycle_state == "PENDING_DELETION"
