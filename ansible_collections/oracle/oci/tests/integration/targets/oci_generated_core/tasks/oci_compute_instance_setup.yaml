- name: Create network_security_group
  oci_network_security_group:
    compartment_id: "{{ test_compartment_ocid }}"
    display_name: "my_nsg_{{random_suffix_1024}}"
    vcn_id: "{{ common_vcn_id }}"
  register: result

- set_fact:
    setup_instance_nsg_id: "{{result.network_security_group.id}}"

- name: Create a temporary directory to house a temporary SSH keypair we will later use to connect to instance
  tempfile:
    state: directory
    suffix: cert
  register: result
- set_fact:
    temp_certificates_path: "{{ result.path }}"
- name: Generate a Private Key
  openssl_privatekey:
    path: "{{ temp_certificates_path }}/private_key.pem"
    type: RSA
    size: 2048
- set_fact:
    my_test_public_key_path: "{{ temp_certificates_path }}/public_key.pem"
- name: Generate a Public Key
  openssl_publickey:
    path: "{{ my_test_public_key_path }}"
    privatekey_path: "{{ temp_certificates_path }}/private_key.pem"
    format: OpenSSH

## Create/Launch
- name: Create new compute instance
  oci_compute_instance:
    display_name: "{{test_instance_name}}"
    shape: "{{test_instance_shape}}"
    compartment_id: "{{test_compartment_ocid}}"
    availability_domain: "{{test_availability_domain}}"
    source_details:
      source_type: "image"
      image_id: "{{image_ocid}}"
    create_vnic_details:
        hostname_label: "{{test_instance_name}}"
        subnet_id: "{{common_subnet_id}}"
        nsg_ids:
          - "{{ setup_instance_nsg_id }}"
  register: result
# name: Set variable to current instance id
- set_fact:
    setup_instance_id: "{{ result.instance.id }}"
    dependency_instance_id: "{{ result.instance.id }}"
- debug:
    msg: "{{ result }}"
- name: Get boot volume attachment for the setup instance
  oci_compute_boot_volume_attachment_facts:
    compartment_id: "{{ test_compartment_ocid }}"
    availability_domain: "{{ test_availability_domain }}"
    instance_id: "{{ setup_instance_id }}"
  register: result
- set_fact:
    setup_instance_boot_volume_attachment_id: "{{ result.boot_volume_attachments[0].id }}"
    setup_instance_boot_volume_attachment_display_name: "{{ result.boot_volume_attachments[0].display_name }}"
    setup_instance_boot_volume_id: "{{ result.boot_volume_attachments[0].boot_volume_id }}"
