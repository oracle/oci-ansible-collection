---
- block:
  - set_fact:
      test_authentication_policy_update_optional_required_password_policy:
        minimum_password_length: "{{ 112 | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_minimum_password_length, omit) }}"
        is_uppercase_characters_required: "{{ true | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_is_uppercase_characters_required, omit) }}"
        is_lowercase_characters_required: "{{ true | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_is_lowercase_characters_required, omit) }}"
        is_numeric_characters_required: "{{ true | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_is_numeric_characters_required, omit) }}"
        is_special_characters_required: "{{ true | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_is_special_characters_required, omit) }}"
        is_username_containment_allowed: "{{ true | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy_is_username_containment_allowed, omit) }}"
    when: test_authentication_policy_update_optional_required_password_policy is not defined

  - name: Update authentication_policy with optional + required parameters
    oci_identity_authentication_policy:
      compartment_id: "{{ authentication_policy_resource_id | oracle.oci.override(test_authentication_policy_update_optional_required_compartment_id, omit) }}"
      password_policy: "{{ '{}' | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy, omit) }}"
    register: result
    when: skip_authentication_policy_update_optional_required_test is not defined

  - name: Assert resource was updated
    assert:
      that:
        - result.changed == True
    when: skip_authentication_policy_update_optional_required_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.authentication_policy.password_policy is defined
        - result.authentication_policy.compartment_id is defined
    when: skip_authentication_policy_update_optional_required_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ authentication_policy_update_optional_required_custom_assertions }}"
    when: authentication_policy_update_optional_required_custom_assertions is defined

# ==================================================================================================== #

  - name: Update authentication_policy with optional + required parameters (idempotence)
    oci_identity_authentication_policy:
      compartment_id: "{{ authentication_policy_resource_id | oracle.oci.override(test_authentication_policy_update_optional_required_compartment_id, omit) }}"
      password_policy: "{{ '{}' | oracle.oci.override(test_authentication_policy_update_optional_required_password_policy, omit) }}"
    register: result
    when: skip_authentication_policy_update_optional_required_idempotence_test is not defined

  - name: Assert changed is False
    assert:
      that:
        - result.changed == False
    when: skip_authentication_policy_update_optional_required_idempotence_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - result.authentication_policy.password_policy is defined
        - result.authentication_policy.compartment_id is defined
    when: skip_authentication_policy_update_optional_required_idempotence_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ authentication_policy_update_optional_required_idempotence_custom_assertions }}"
    when: authentication_policy_update_optional_required_idempotence_custom_assertions is defined

# ==================================================================================================== #

  - name: Get authentication_policy
    oci_identity_authentication_policy_facts:
      compartment_id: "{{ authentication_policy_resource_id | oracle.oci.override(test_authentication_policy_get_compartment_id, omit) }}"
    register: result
    when: skip_authentication_policy_get_test is not defined

  - name: Assert resource was listed
    assert:
      that:
        - result['authentication_policy'] is defined
        - result['authentication_policy'] != None
    when: skip_authentication_policy_get_test is not defined

  - name: Assert response properties are populated
    assert:
      that:
        - item.password_policy is defined
        - item.compartment_id is defined
    with_items:
      - "{{ result['authentication_policy'] }}"
    when: skip_authentication_policy_get_test is not defined

  - name: Assert custom assertions
    assert:
      that:
        - "{{ item }}"
    with_items: "{{ authentication_policy_get_custom_assertions }}"
    when: authentication_policy_get_custom_assertions is defined

  always:
    - debug:
        msg: "Nothing to clean up since this resource does not have delete operation and also no dependencies."
